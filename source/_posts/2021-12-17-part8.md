---
title: 直播弹幕实现方案
date: 2021-12-17
tags:
- js
---

#### 一、并发

弹幕数据会通过异步请求或 socket 消息传到前端，会存在一个隐患，就是数据量可能非常大。如果一收到弹幕数据就马上渲染出来，在量大的时候：
<!--more-->

   显示区域不足以放置这么多的弹幕，弹幕会堆叠在一起
   渲染过程会占用大量 CPU 资源，导致页面卡顿

思路是把收到的弹幕数据都存入数组，再通过轮询该数组，把弹幕逐条渲染出来。

#### 二、弹幕的滚动

弹幕的滚动本质上是位移动画，从显示区域的右侧移动到左侧。前端实现位移动画有两种方案——DOM 和 canvas。

DOM 方案实现的动画较为流畅，且一些特殊效果（如文字阴影）较容易实现（只要在 CSS 中设置对应的属性即可）

Canvas 方案的动画流畅度要差一些，要做特殊效果也不那么容易，但是它在 CPU 占用上有优势

#### 三、Dom实现，通过CSS 的 transition 和 transform 来实现动画

实现方式是将页面视频容器划分为16行7列，填充7 * 16个dom元素，每一行7个dom元素，每一行定义为一个通道，总共16个通道。

初始化设置相应每个dom的top和transform: translateX(值)，定义16行7列的二维数组domPool存储初始化的dom元素，定义数组hasPosition标记每个通道当前是否有位置，然后需要一个数组danmuPool存取后端返回的弹幕。

定义一个发射弹幕的方法shootDanmu，每1毫秒从上往下检测当前通道是否占满，拿取danmuPool里面的一条数据push进去相对应的通道里面，然后改变transform: translateX的数值让弹幕滑动到左边位置划出，在释放相对应的通道，清空当前位置dom的数据重新初始化。

#### 四、弹幕速度不一致问题

由于弹幕从左到右的路程是确定不变的，弹幕的长度不同，速度也就不一样，长度越长，速度也就越快。

弹幕重叠问题

目前两条弹幕的间距是依据弹幕的长度外加1s的时间作为判断依据的，当弹幕众多的，重叠还是会存在，要避免重叠，就要通过弹幕的长度和总的路程计算出同一通道两条弹幕的速度，控制速度的大小限制。




